#@ load("@ytt:data", "data")
#@ load("@ytt:assert", "assert")

#@ def get_application_containers(application):
#@ if application == "isilon":
#@    return get_containers_isilon(application)
#@ elif application == "vxflexos":
#@    return get_containers_vxflexos(application)
#@ else:
#@ assert.fail("containers for application {} not found".format(application))
#@ end
#@ end

#! CONTAINER SPECS for application csi-isilon
#@ def get_containers_isilon(application):
containers:
  - #@ registrar_container_spec(application)
  - #@ driver_isilon_container_spec()
#@ end


#! CONTAINER SPECS for application csi-vxflexos
#@ def get_containers_vxflexos(application):
containers:
  - #@ registrar_container_spec(application)
  #@ if data.values.podmon.enabled:
  - #@ podman_container_spec()
  #@ end
  - #@ driver_vxflexos_container_spec()
#@ end


#! spec for registrar sidecar container
#@ def registrar_container_spec(application):
name: registrar
image: #@ data.values.images.registrar
args:
  - "--v=5"
  - "--csi-address=$(ADDRESS)"
  #@ if application == "isilon":
  - --kubelet-registration-path=/var/lib/kubelet/plugins/csi-isilon/csi_sock
  #@ elif application == "vxflexos":
  - --kubelet-registration-path=/var/lib/kubelet/plugins/vxflexos.emc.dell.com/csi_sock
  #@ end
env:
  - name: ADDRESS
    value: /csi/csi_sock
  - name: KUBE_NODE_NAME
    valueFrom:
      fieldRef:
        apiVersion: v1
        fieldPath: spec.nodeName
volumeMounts:
  - name: registration-dir
    mountPath: /registration
  - name: driver-path
    mountPath: /csi
#@ end

#! spec for podman sidecar container
#@ def podman_container_spec():
name: podmon
securityContext:
  privileged: true
  capabilities:
    add: ["SYS_ADMIN"]
  allowPrivilegeEscalation: true
imagePullPolicy: Always
image: #@ data.values.podmon.image
args: #@ data.values.podmon.node.args
env:
  - name: KUBE_NODE_NAME
    valueFrom:
      fieldRef:
        apiVersion: v1
        fieldPath: spec.nodeName
  - name: X_CSI_PRIVATE_MOUNT_DIR
    value: "/var/lib/kubelet/plugins/vxflexos.emc.dell.com/disks"
  - name: MY_NODE_NAME
    valueFrom:
      fieldRef:
        fieldPath: spec.nodeName
  - name: MY_POD_NAME
    valueFrom:
      fieldRef:
        fieldPath: metadata.name
  - name: MY_POD_NAMESPACE
    valueFrom:
      fieldRef:
        fieldPath: metadata.namespace
volumeMounts:
  - name: kubelet-pods
    mountPath: /var/lib/kubelet/pods
    mountPropagation: "Bidirectional"
  - name: driver-path
    mountPath: /var/lib/kubelet/plugins/vxflexos.emc.dell.com
    mountPropagation: "Bidirectional"
  - name: usr-bin
    mountPath: /usr-bin
  - name: var-run
    mountPath: /var/run
#@ end

#! spec for csi-isilon driver sidecar container
#@ def driver_isilon_container_spec():
name: driver
command: [ "/csi-isilon" ]
securityContext:
  privileged: true
  capabilities:
    add: [ "SYS_ADMIN" ]
  allowPrivilegeEscalation: true
image: #@ data.values.images.driver
imagePullPolicy: IfNotPresent
env:
  - name: CSI_ENDPOINT
    value: /var/lib/kubelet/plugins/csi-isilon/csi_sock
  - name: X_CSI_MODE
    value: node
  - name: X_CSI_DEBUG
    value: #@ data.values.enableDebug
  - name: X_CSI_ISI_INSECURE
    value: #@ data.values.isiInsecure
  - name: X_CSI_ALLOWED_NETWORKS
    value: #@ str(data.values.allowedNetworks)
  - name: X_CSI_VERBOSE
    value: #@ str(data.values.verbose)
  - name: X_CSI_PRIVATE_MOUNT_DIR
    value: "/var/lib/kubelet/plugins/csi-isilon/disks"
  - name: X_CSI_ISI_PORT
    value: #@ data.values.isiPort
  - name: X_CSI_ISI_PATH
    value: #@ data.values.isiPath
  - name: X_CSI_ISILON_NO_PROBE_ON_START
    value: #@ data.values.noProbeOnStart
  - name: X_CSI_ISILON_NFS_V3
    value: #@ data.values.nfsV3
  - name: X_CSI_ISI_AUTOPROBE
    value: #@ data.values.autoProbe
  - name: X_CSI_NODE_NAME
    valueFrom:
      fieldRef:
        fieldPath: spec.nodeName
  - name: X_CSI_NODE_IP
    valueFrom:
      fieldRef:
        fieldPath: status.hostIP
  - name: SSL_CERT_DIR
    value: /certs
  - name: X_CSI_ISI_QUOTA_ENABLED
    value: #@ data.values.enableQuota
  - name: X_CSI_CUSTOM_TOPOLOGY_ENABLED
    value: #@ data.values.enableCustomTopology
  - name: X_CSI_ISILON_CONFIG_PATH
    value: /isilon-configs/config
  - name: X_CSI_MAX_VOLUMES_PER_NODE
    value: #@ str(data.values.maxIsilonVolumesPerNode)
volumeMounts:
  - name: driver-path
    mountPath: /var/lib/kubelet/plugins/csi-isilon
  - name: volumedevices-path
    mountPath: /var/lib/kubelet/plugins/kubernetes.io/csi/volumeDevices
  - name: pods-path
    mountPath: /var/lib/kubelet/pods
    mountPropagation: "Bidirectional"
  - name: dev
    mountPath: /dev
  - name: certs
    mountPath: /certs
    readOnly: true
  - name: isilon-configs
    mountPath: /isilon-configs

#@ end


#! spec for csi-vxflexos driver sidecar container
#@ def driver_vxflexos_container_spec():
name: driver
securityContext:
  privileged: true
  allowPrivilegeEscalation: true
  capabilities:
    add: ["SYS_ADMIN"]
image: #@ data.values.images.driver
imagePullPolicy: IfNotPresent
command: [ "/csi-vxflexos.sh" ]
args:
  - "--array-config=/vxflexos-config/config"
env:
  - name: CSI_ENDPOINT
    value: unix:///var/lib/kubelet/plugins/vxflexos.emc.dell.com/csi_sock
  - name: X_CSI_MODE
    value: node
  - name: X_CSI_DEBUG
    value: "true"
  - name: X_CSI_PRIVATE_MOUNT_DIR
    value: "/var/lib/kubelet/plugins/vxflexos.emc.dell.com/disks"
  - name: X_CSI_ALLOW_RWO_MULTI_POD_ACCESS
    value: #@ data.values.allowRWOMultiPodAccess
volumeMounts:
  - name: driver-path
    mountPath: /var/lib/kubelet/plugins/vxflexos.emc.dell.com
  - name: volumedevices-path
    mountPath: /var/lib/kubelet/plugins/kubernetes.io/csi/volumeDevices
    mountPropagation: "Bidirectional"
  - name: pods-path
    mountPath: /var/lib/kubelet/pods
    mountPropagation: "Bidirectional"
  - name: dev
    mountPath: /dev
  - name: vxflexos-config
    mountPath: /vxflexos-config
#@ end